L.KML=L.FeatureGroup.extend({initialize:function(kml){this._kml=kml,this._layers={},kml&&this.addKML(kml)},addKML:function(xml){var layers=L.KML.parseKML(xml);if(layers&&layers.length){for(var i=0;i<layers.length;i++)this.fire("addlayer",{layer:layers[i]}),this.addLayer(layers[i]);this.latLngs=L.KML.getLatLngs(xml),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(xml){var style=this.parseStyles(xml);this.parseStyleMap(xml,style);for(var el=xml.getElementsByTagName("Folder"),layers=[],l,i=0;i<el.length;i++)this._check_folder(el[i])&&(l=this.parseFolder(el[i],style))&&layers.push(l);el=xml.getElementsByTagName("Placemark");for(var j=0;j<el.length;j++)this._check_folder(el[j])&&(l=this.parsePlacemark(el[j],xml,style))&&layers.push(l);el=xml.getElementsByTagName("GroundOverlay");for(var k=0;k<el.length;k++)(l=this.parseGroundOverlay(el[k]))&&layers.push(l);return layers},_check_folder:function(e,folder){for(e=e.parentNode;e&&"Folder"!==e.tagName;)e=e.parentNode;return!e||e===folder},parseStyles:function(xml){for(var styles={},sl=xml.getElementsByTagName("Style"),i=0,len=sl.length;i<len;i++){var style=this.parseStyle(sl[i]),styleName;if(style)styles["#"+style.id]=style}return styles},parseStyle:function(xml){var style={},poptions={},ioptions={},el,id,attributes={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0};function _parse(xml){for(var options={},i=0;i<xml.childNodes.length;i++){var e=xml.childNodes[i],key=e.tagName;if(attributes[key])if("hotSpot"===key)for(var j=0;j<e.attributes.length;j++)options[e.attributes[j].name]=e.attributes[j].nodeValue;else{var value=e.childNodes[0].nodeValue;"color"===key?(options.opacity=parseInt(value.substring(0,2),16)/255,options.color="#"+value.substring(6,8)+value.substring(4,6)+value.substring(2,4)):"width"===key?options.weight=value:"Icon"===key?(ioptions=_parse(e)).href&&(options.href=ioptions.href):"href"===key&&(options.href=value)}}return options}return(el=xml.getElementsByTagName("LineStyle"))&&el[0]&&(style=_parse(el[0])),(el=xml.getElementsByTagName("PolyStyle"))&&el[0]&&(poptions=_parse(el[0])),poptions.color&&(style.fillColor=poptions.color),poptions.opacity&&(style.fillOpacity=poptions.opacity),(el=xml.getElementsByTagName("IconStyle"))&&el[0]&&(ioptions=_parse(el[0])),ioptions.href&&(style.icon=new L.KMLIcon({iconUrl:ioptions.href,shadowUrl:null,anchorRef:{x:ioptions.x,y:ioptions.y},anchorType:{x:ioptions.xunits,y:ioptions.yunits}})),(id=xml.getAttribute("id"))&&style&&(style.id=id),style},parseStyleMap:function(xml,existingStyles){for(var sl=xml.getElementsByTagName("StyleMap"),i=0;i<sl.length;i++){var e=sl[i],el,smKey,smStyleUrl;(el=e.getElementsByTagName("key"))&&el[0]&&(smKey=el[0].textContent),(el=e.getElementsByTagName("styleUrl"))&&el[0]&&(smStyleUrl=el[0].textContent),"normal"===smKey&&(existingStyles["#"+e.getAttribute("id")]=existingStyles[smStyleUrl])}},parseFolder:function(xml,style){var el,layers=[],l;el=xml.getElementsByTagName("Folder");for(var i=0;i<el.length;i++)this._check_folder(el[i],xml)&&(l=this.parseFolder(el[i],style))&&layers.push(l);el=xml.getElementsByTagName("Placemark");for(var j=0;j<el.length;j++)this._check_folder(el[j],xml)&&(l=this.parsePlacemark(el[j],xml,style))&&layers.push(l);el=xml.getElementsByTagName("GroundOverlay");for(var k=0;k<el.length;k++)this._check_folder(el[k],xml)&&(l=this.parseGroundOverlay(el[k]))&&layers.push(l);if(layers.length)return 1===layers.length?layers[0]:new L.FeatureGroup(layers)},parsePlacemark:function(place,xml,style,options){var h,i,j,k,el,il,opts=options||{};for(el=place.getElementsByTagName("styleUrl"),i=0;i<el.length;i++){var url=el[i].childNodes[0].nodeValue;for(var a in style[url])opts[a]=style[url][a]}if(il=place.getElementsByTagName("Style")[0]){var inlineStyle=this.parseStyle(place);if(inlineStyle)for(k in inlineStyle)opts[k]=inlineStyle[k]}var multi=["MultiGeometry","MultiTrack","gx:MultiTrack"];for(h in multi)for(el=place.getElementsByTagName(multi[h]),i=0;i<el.length;i++)return this.parsePlacemark(el[i],xml,style,opts);var layers=[],parse=["LineString","Polygon","Point","Track","gx:Track"];for(j in parse){var tag=parse[j];for(el=place.getElementsByTagName(tag),i=0;i<el.length;i++){var l=this["parse"+tag.replace(/gx:/,"")](el[i],xml,opts);l&&layers.push(l)}}if(layers.length){var layer=layers[0];layers.length>1&&(layer=new L.FeatureGroup(layers));var name,descr="";for((el=place.getElementsByTagName("name")).length&&el[0].childNodes.length&&(name=el[0].childNodes[0].nodeValue),el=place.getElementsByTagName("description"),i=0;i<el.length;i++)for(j=0;j<el[i].childNodes.length;j++)descr+=el[i].childNodes[j].nodeValue;return name&&layer.on("add",(function(){layer.bindPopup("<h2>"+name+"</h2>"+descr,{className:"kml-popup"})})),layer}},parseCoords:function(xml){var el=xml.getElementsByTagName("coordinates");return this._read_coords(el[0])},parseLineString:function(line,xml,options){var coords=this.parseCoords(line);if(coords.length)return new L.Polyline(coords,options)},parseTrack:function(line,xml,options){var el=xml.getElementsByTagName("gx:coord");0===el.length&&(el=xml.getElementsByTagName("coord"));for(var coords=[],j=0;j<el.length;j++)coords=coords.concat(this._read_gxcoords(el[j]));if(coords.length)return new L.Polyline(coords,options)},parsePoint:function(line,xml,options){var el=line.getElementsByTagName("coordinates");if(el.length){var ll=el[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(ll[1],ll[0]),options)}},parsePolygon:function(line,xml,options){var el,polys=[],inner=[],i,coords;for(el=line.getElementsByTagName("outerBoundaryIs"),i=0;i<el.length;i++)(coords=this.parseCoords(el[i]))&&polys.push(coords);for(el=line.getElementsByTagName("innerBoundaryIs"),i=0;i<el.length;i++)(coords=this.parseCoords(el[i]))&&inner.push(coords);if(polys.length)return options.fillColor&&(options.fill=!0),1===polys.length?new L.Polygon(polys.concat(inner),options):new L.MultiPolygon(polys,options)},getLatLngs:function(xml){for(var el=xml.getElementsByTagName("coordinates"),coords=[],j=0;j<el.length;j++)coords=coords.concat(this._read_coords(el[j]));return coords},_read_coords:function(el){var text="",coords=[],i;for(i=0;i<el.childNodes.length;i++)text+=el.childNodes[i].nodeValue;for(text=text.split(/[\s\n]+/),i=0;i<text.length;i++){var ll=text[i].split(",");ll.length<2||coords.push(new L.LatLng(ll[1],ll[0]))}return coords},_read_gxcoords:function(el){var text="",coords=[];return text=el.firstChild.nodeValue.split(" "),coords.push(new L.LatLng(text[1],text[0])),coords},parseGroundOverlay:function(xml){var latlonbox=xml.getElementsByTagName("LatLonBox")[0],bounds=new L.LatLngBounds([latlonbox.getElementsByTagName("south")[0].childNodes[0].nodeValue,latlonbox.getElementsByTagName("west")[0].childNodes[0].nodeValue],[latlonbox.getElementsByTagName("north")[0].childNodes[0].nodeValue,latlonbox.getElementsByTagName("east")[0].childNodes[0].nodeValue]),attributes={Icon:!0,href:!0,color:!0};function _parse(xml){for(var options={},ioptions={},i=0;i<xml.childNodes.length;i++){var e=xml.childNodes[i],key=e.tagName;if(attributes[key]){var value=e.childNodes[0].nodeValue;"Icon"===key?(ioptions=_parse(e)).href&&(options.href=ioptions.href):"href"===key?options.href=value:"color"===key&&(options.opacity=parseInt(value.substring(0,2),16)/255,options.color="#"+value.substring(6,8)+value.substring(4,6)+value.substring(2,4))}}return options}var options={};if(options=_parse(xml),void 0!==latlonbox.getElementsByTagName("rotation")[0]){var rotation=latlonbox.getElementsByTagName("rotation")[0].childNodes[0].nodeValue;options.rotation=parseFloat(rotation)}return new L.RotatedImageOverlay(options.href,bounds,{opacity:options.opacity,angle:options.rotation})}}),L.KMLIcon=L.Icon.extend({options:{iconSize:[40,40],iconAnchor:[16,16]},_setIconStyles:function(img,name){L.Icon.prototype._setIconStyles.apply(this,[img,name]),img.complete?this.applyCustomStyles(img):img.onload=this.applyCustomStyles.bind(this,img)},applyCustomStyles:function(img){var options=this.options;this.options.popupAnchor=[0,-.83*img.height],"fraction"===options.anchorType.x&&(img.style.marginLeft=-options.anchorRef.x*img.width+"px"),"fraction"===options.anchorType.y&&(img.style.marginTop=-(1-options.anchorRef.y)*img.height+1+"px"),"pixels"===options.anchorType.x&&(img.style.marginLeft=-options.anchorRef.x+"px"),"pixels"===options.anchorType.y&&(img.style.marginTop=options.anchorRef.y-img.height+1+"px")}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}}),L.RotatedImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){if(L.DomUtil.TRANSFORM)this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var rad=this.options.angle*(Math.PI/180),costheta=Math.cos(rad),sintheta=Math.sin(rad);this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+costheta+", M12="+-sintheta+", M21="+sintheta+", M22="+costheta+")"}},getBounds:function(){return this._bounds}});