<!DOCTYPE html>
<html>

<head>

    <title>Proyecto TIG Emilia Rosa van der Heide</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <!-- GEOTIF 
    <script src="js/geotiff.js/dist/geotiff.bundle.js"></script>-->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <!-- <script src="https://unpkg.com/geotiff@0.4.1/dist/geotiff.browserify.js"></script> -->
    <script src="https://unpkg.com/plotty@0.2.0/src/plotty.js"></script>
    <script src="js/leaflet-geotiff/leaflet-geotiff.js"></script>

    <!-- Load any renderer you need -->
    <script src="js/leaflet-geotiff/leaflet-geotiff-plotty.js"></script>
    <script src="js/leaflet-geotiff/leaflet-geotiff-vector-arrows.js"></script>


    <!-- CanvasLayer Field -->
    <!-- CDN references -->
    <script src="//npmcdn.com/leaflet@1.2.0/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="//npmcdn.com/geotiff@0.3.6/dist/geotiff.js"></script>

    <!-- Plugin -->
    <script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>

    <!-- Shapefile -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="js/leaflet.shpfile.js"></script>

    <!-- Fullscreen button -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet' />

    <!-- Measure button  -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.min.js"></script>
    <link rel="stylesheet" href="css/leaflet-measure.css" integrity="" crossorigin="" />

    <!-- Locate button -->
    <script
        src='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.mapbox.css'
        rel='stylesheet' />
    <!--[if lt IE 9]>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.ie.css' rel='stylesheet' />
    <![endif]-->
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/css/font-awesome.min.css'
        rel='stylesheet' />

    <!-- Minimap 
    <link rel="stylesheet" href="Plugins/L.Control.MousePosition.css" /> -->
    <link rel="stylesheet" href="css/Control.MiniMap.css" />
    <script src="js/Control.MiniMap.js" type="text/javascript"></script>

    <!-- Print -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.browser.print@1.0.2/dist/leaflet.browser.print.min.js"></script>

    <!-- KML -->
    <script src="js/L.KML.min.js"></script>

    <!-- Styled control layers -->
    <link rel="stylesheet" href="http://davicustodio.github.io/Leaflet.StyledLayerControl/css/styledLayerControl.css" />
    <script src="http://davicustodio.github.io/Leaflet.StyledLayerControl/src/styledLayerControl.js"></script>

    <!-- Mis scripts -->
    <script src="js/cargarArchivos.js"></script>
</head>
<style>
    body {
        padding: 0;
        margin: 0;
    }

    html,
    body {
        height: 100%;
        width: 100vw;
    }

    .legend {
        line-height: 18px;
        width: 150px;
        color: #555;
    }

    .legend i {
        width: 20px;
        height: 18px;
        float: left;
        margin-right: 5px;
        opacity: 0.7;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    #map input {
        margin-left: 5px;
        padding-bottom: 2px;
    }

    #map article {
        padding-bottom: 5px;
    }
</style>

<body>
    <div class="row">
        <div class="col-lg-8">
            <div id="map" class="" style="height: 100vh;"></div>
        </div>
        <div class="col-md-4">
            <div class="card my-4 mr-4">
                <h5 class="card-header">¡Bienvenido!</h5>
                <div class="card-body">
                    <p>
                        En esta página web podrá encontrar 10 capas sobre el mapa de la Península Ibérica. Todas las
                        capas tienen información acerca de los datos que representan. (Pincha en algún punto de la capa
                        para observar la información.)<br><br>

                        Tenemos 3 capas raster: <br>
                        - Las precipitaciones de junio de 2007 <br>
                        - Las temperaturas medias (interpoladas) de junio de 2007 <br>
                        - La severidad del incendio de Marxuquera <br> <br>

                        Tenemos 6 capas vectoriales: <br>
                        - El tipo de vegetación de Marxuquera <br>
                        - Área y perímetro de algunas zonas de Marxuquera (combinación)<br>
                        - Contornos <br>
                        - Provincias lluvia <br>
                        - Los puntos de Lluvia <br>
                        - La aptitud para la repoblación de vegetación de Ayora. <br><br>

                        - Tenemos una ruta KML con información en los waypoints (clicando los markers).

                        Hay varios mapas base disponibles en el selector de capas arriba a la derecha.
                    </p>
                </div>
            </div>
            <div class="card my-4 mr-4">
                <h5 class="card-header">Información general</h5>
                <div class="card-body">
                    Hecho por: <b>Emilia Rosa van der Heide</b><br>
                    <small>Tecnologías de la Información Geográfica<br>
                        Grado en Tecnologías Interactivas<br>
                        <b>Universidad Politénica de Valencia</b></small>
                </div>
            </div>
        </div>
    </div>
    <script>
        var map;
        var legend;
        var baseMaps = [
            {
                groupName: "Base Maps",
                expanded: true,
                layers: {}
            }
        ];
        var overlayMaps = [
            {
                groupName: "Precipitaciones",
                expanded: true,
                layers: {}
            }, {
                groupName: "Temperaturas",
                expanded: true,
                layers: {}
            }, {
                groupName: "Incendio",
                expanded: true,
                layers: {}
            }, {
                groupName: "KML",
                expanded: true,
                layers: {}
            }, {
                groupName: "dNBR",
                expanded: true,
                layers: {}
            }
        ];
        // Creamos el mapa
        crearMapa()

        async function crearMapa() {
            // Basemap watercolor
            var Basemap_Stamen_Watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>',
                subdomains: 'abcd',
                minZoom: 1,
                maxZoom: 16,
                ext: 'jpg'
            });

            // Basemap topográfico
            var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
            });

            // Basemap terreno
            var Stamen_TerrainBackground = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}{r}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>',
                subdomains: 'abcd',
                minZoom: 0,
                maxZoom: 18,
                ext: 'png'
            });

            // Basemap calles
            var OpenMapSurfer_Roads = L.tileLayer('https://maps.heigit.org/openmapsurfer/tiles/roads/webmercator/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a>'
            });

            // Asignamos los basemap a su grupo correspondiente
            baseMaps[0].layers["Topográfico"] = Esri_WorldTopoMap;
            baseMaps[0].layers["Terreno"] = Stamen_TerrainBackground;
            baseMaps[0].layers["Calles"] = OpenMapSurfer_Roads;
            baseMaps[0].layers["Watercolor"] = Basemap_Stamen_Watercolor;

            // El mapa principal
            map = L.map('map', {
                center: [40.4637, -3.7492],
                zoom: 5,
                layers: [Esri_WorldTopoMap]
            });

            // Añadimos una escala al mapa
            var scale = L.control.scale();
            scale.addTo(map);

            // Añadimos un botón de pantalla completa
            map.addControl(new L.Control.Fullscreen());

            // Añadimos botón de medir
            measureOptions = {
                position: 'topleft',
                primaryLengthUnit: 'meters', secondaryLengthUnit: 'miles',
                primaryAreaUnit: 'hectares',
                activeColor: '#8921FF',
                completedColor: '#1801FF'
            }
            var measureControl = new L.Control.Measure(measureOptions);
            measureControl.addTo(map);

            // Añadimos botón de imprimir
            L.control.browserPrint({
                documentTitle: 'Mapa projecto Emilia Rosa van der Heide',
            }).addTo(map);

            // Añadimos minimap
            var osmUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
            var osmAttrib = 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
            var osm2 = new L.TileLayer(osmUrl, { minZoom: 0, maxZoom: 13, attribution: osmAttrib });
            var miniMap = new L.Control.MiniMap(osm2, { toggleDisplay: true }).addTo(map);

            // Añadimos botón de encontrar mi localización
            L.control.locate().addTo(map);

            // Añadimos las capas al mapa
            // Cargamos los GeoTIFF
            await cargaTiff("data/interplacionlluviaextract.tif", "Lluvia", "Precipitaciones");
            // overlayMaps["Lluvia"].addTo(map)
            await cargaTiff("data/temperaturasinterpolacion.tif", "Temperaturas", "Temperaturas")
            //await cargaTiff("data/dnbr201809.tif", "dNBR septiembre 2018");
            // await cargaTiff("data/corine_incendio.tif", "Incendio");

            // Cargamos los shapefile zips
            await cargaShapefileZip("data/corine-incendio.zip", "Vegetacion", "Incendio")
            await cargaShapefileZip("data/combinacion.zip", "Combinación", "Incendio")
            await cargaShapefileZip("data/contornos.zip", "Contornos", "Precipitaciones")
            await cargaShapefileZip("data/puntoslluvia.zip", "Provincias lluvia", "Precipitaciones")
            await cargaShapefileZip("data/puntos.zip", "Puntos lluvia", "Precipitaciones")
            await cargaShapefileZip("data/solucionfinal.zip", "Repoblación", "dNBR")

            await leerKML("data/KML.kml", "Ruta KML", "KML")

            crearControlCapas();
        }

        function crearControlCapas() {

            //  var control = L.control.layers(baseMaps, overlayMaps).addTo(map);

            var options = {
                container_width: "250px",
                /*container_maxHeight: "350px",
                group_maxHeight: "80px",
                exclusive: false*/
            };

            var control = L.Control.styledLayerControl(baseMaps, overlayMaps, options);
            map.addControl(control);

            L.Control.Custom = L.Control.Layers.extend({
                onAdd: function () {
                    this._addButton();
                    return this._container;
                },
                _addButton: function () {
                    // Añadimos texto al principio
                    var elements = document.getElementsByClassName('leaflet-control-layers-list');
                    var html = elements[0].innerHTML;
                    elements[0].innerHTML = '<h6 class="bg-info text-white text-center p-1 rounded">Mapas base</h6>' + html;

                    // Añadimos texto a la separacion Geotiff
                    var elements2 = document.getElementsByClassName('leaflet-control-layers-overlays');
                    var html2 = elements2[0].innerHTML;
                    elements2[0].innerHTML = '<h6 class="bg-info text-white text-center p-1 rounded">Capas GEOTiff</h6>' + html2;

                    // Añadimos texto a la separacion shape
                    var elements3 = elements2[0].getElementsByTagName('label');
                    var html3 = elements3[3].innerHTML;
                    elements3[3].innerHTML = '<h6 class="bg-info text-white text-center p-1 rounded">Capas Shape</h6>' + html3;
                }
            })

            //   var control = new L.Control.Custom(baseMaps, overlayMaps).addTo(map);

            // Añadimos los basemaps y overlays al mapa
            //    L.control.layers(baseMaps, overlayMaps).addTo(map);

            // Se activa cuando se añade una capa
            map.on('overlayadd', function (overlay) {
                // Cogemos los bounds de la capa añadida
                var bounds = overlay.layer.getBounds();

                // Si los bounds existen hacemos zoom al overlay
                if (Object.keys(bounds).length > 0) map.fitBounds(bounds);

                // Añadimos leyenda
                if (overlay.name == "Vegetacion") {
                    legend = L.control({ position: 'bottomright' });

                    legend.onAdd = function (map) {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 100, 200, 300, 400],
                            labels = [];
                        div.innerHTML = '<h6 class="text-center">Área</h6>'
                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                            div.innerHTML +=
                                '<div class="row"><div class="col-4 pr-0"><i style="background:' + getColorVegetacion(grades[i] + 1) + '" class=""></i></div> <span class="my-auto m-100 col-8 pl-0">' +
                                grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + 'ha</span></div>' : '+');
                        }
                        return div;
                    };

                    legend.addTo(map);
                }
                else {
                    map.removeControl(legend)
                }
            })

            // Se activa cuando se borra una capa
            map.on('overlayremove', function (overlay) {
                // Quitamos leyenda
                if (overlay.name == "Vegetacion") {
                    map.removeControl(legend)
                }
            })
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

</body>

</html>