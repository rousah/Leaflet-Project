<!DOCTYPE html>
<html>

<head>

    <title>Proyecto Tecnologías de la Información Geográfica</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>

    <!-- GEOTIF 
    <script src="js/geotiff.js/dist/geotiff.bundle.js"></script>-->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <!-- <script src="https://unpkg.com/geotiff@0.4.1/dist/geotiff.browserify.js"></script> -->
    <script src="https://unpkg.com/plotty@0.2.0/src/plotty.js"></script>
    <script src="js/leaflet-geotiff/leaflet-geotiff.js"></script>

    <!-- Load any renderer you need -->
    <script src="js/leaflet-geotiff/leaflet-geotiff-plotty.js"></script>
    <script src="js/leaflet-geotiff/leaflet-geotiff-vector-arrows.js"></script>


    <!-- CanvasLayer Field -->
    <!-- CDN references -->
    <script src="//npmcdn.com/leaflet@1.2.0/dist/leaflet.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="//npmcdn.com/geotiff@0.3.6/dist/geotiff.js"></script>

    <!-- Plugin -->
    <script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>

    <!-- GeoJSON -->
    <script src="data/puntosLluvia.js"></script>

    <!-- Shapefile -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="js/leaflet.shpfile.js"></script>

    <!-- Fullscreen button -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet' />

    <!-- Measure button  -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.min.js"></script>
    <link rel="stylesheet" href="css/leaflet-measure.css" integrity="" crossorigin="" />

    <!-- Locate button -->
    <script
        src='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.mapbox.css'
        rel='stylesheet' />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@[VERSION]/dist/L.Control.Locate.min.css" />

    <!--[if lt IE 9]>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.ie.css' rel='stylesheet' />
    <![endif]-->
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/css/font-awesome.min.css'
        rel='stylesheet' />

    <!-- Mis scripts -->
    <script src="js/cargarArchivos.js"></script>
</head>

<body>
    <div id="map" style="width: 1200px; height: 800px;"></div>
    <script>
        var map;
        var baseMaps = {};
        var overlayMaps = {};
        // Creamos el mapa
        crearMapa()

        async function crearMapa() {
            // Basemap watercolor
            var Basemap_Stamen_Watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>',
                subdomains: 'abcd',
                minZoom: 1,
                maxZoom: 16,
                ext: 'jpg'
            });

            // Basemap topográfico
            var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
            });

            // Basemap terreno
            var Stamen_TerrainBackground = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}{r}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>',
                subdomains: 'abcd',
                minZoom: 0,
                maxZoom: 18,
                ext: 'png'
            });

            // Basemap calles
            var OpenMapSurfer_Roads = L.tileLayer('https://maps.heigit.org/openmapsurfer/tiles/roads/webmercator/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a>'
            });

            // Asignamos los basemap a su grupo correspondiente
            baseMaps["Topográfico"] = Esri_WorldTopoMap;
            baseMaps["Terreno"] = Stamen_TerrainBackground;
            baseMaps["Calles"] = OpenMapSurfer_Roads;
            baseMaps["Watercolor"] = Basemap_Stamen_Watercolor;

            // El mapa principal
            map = L.map('map', {
                center: [40.4637, -3.7492],
                zoom: 5,
                layers: [Esri_WorldTopoMap]
            });

            // Añadimos una escala al mapa
            var scale = L.control.scale();
            scale.addTo(map);

            // Añadimos un botón de pantalla completa
            map.addControl(new L.Control.Fullscreen());

            // Añadimos botón de medir
            measureOptions = {
                position: 'topleft',
                primaryLengthUnit: 'meters', secondaryLengthUnit: 'miles',
                primaryAreaUnit: 'hectares',
                activeColor: '#8921FF',
                completedColor: '#1801FF'
            }
            var measureControl = new L.Control.Measure(measureOptions);
            measureControl.addTo(map);

            // Añadimos botón de encontrar mi localización
            L.control.locate().addTo(map);

            // Añadimos las capas al mapa
            // Cargamos los GeoTIFF
            await cargaTiff("data/corine_incendio.tif", "Incendio");
            await cargaTiff("data/interplacionlluviaextract.tif", "Lluvia");
            await cargaTiff("data/dnbr201809.tif", "dNBR septiembre 2018");

            // Cargamos los shapefile zips
            await cargaShapefileZip("data/corine-incendio.zip", "Vegetacion")
            await cargaShapefileZip("data/puntoslluvia.zip", "Puntos lluvia")
            await cargaShapefileZip("data/solucionfinal.zip", "Repoblación")

            crearControlCapas();
        }

        function crearControlCapas() {
            // Añadimos los basemaps y overlays al mapa
            L.control.layers(baseMaps, overlayMaps).addTo(map);

            // Se activa cuando se añade una capa
            map.on('overlayadd', function (overlay) {
                // Cogemos los bounds de la capa añadida
                var bounds = overlay.layer.getBounds();

                // Si los bounds existen hacemos zoom al overlay
                if (Object.keys(bounds).length > 0) map.fitBounds(bounds);
            })
        }
    </script>

</body>

</html>